"use strict";(self.webpackChunkmu_website=self.webpackChunkmu_website||[]).push([[7859],{2189:(r,n,o)=>{o.r(n),o.d(n,{assets:()=>p,contentTitle:()=>i,default:()=>c,frontMatter:()=>t,metadata:()=>d,toc:()=>u});var e=o(74848),s=o(28453);const t={},i="\u8bcd\u4e91\u7edf\u8ba1",d={id:"Blog/QQBot/\u8bcd\u4e91\u7edf\u8ba1",title:"\u8bcd\u4e91\u7edf\u8ba1",description:"2024-6-14",source:"@site/docs/Blog/05-QQBot/05-\u8bcd\u4e91\u7edf\u8ba1.md",sourceDirName:"Blog/05-QQBot",slug:"/Blog/QQBot/\u8bcd\u4e91\u7edf\u8ba1",permalink:"/docs/Blog/QQBot/\u8bcd\u4e91\u7edf\u8ba1",draft:!1,unlisted:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/Blog/05-QQBot/05-\u8bcd\u4e91\u7edf\u8ba1.md",tags:[],version:"current",sidebarPosition:5,frontMatter:{},sidebar:"Blog",previous:{title:"BOT\u7ba1\u7406\u5458",permalink:"/docs/Blog/QQBot/BOT\u7ba1\u7406\u5458"},next:{title:"\u5173\u952e\u8bcd\u63d0\u9192",permalink:"/docs/Blog/QQBot/\u5173\u952e\u8bcd\u63d0\u9192"}},p={},u=[{value:"\u529f\u80fd\u8bbe\u8ba1",id:"\u529f\u80fd\u8bbe\u8ba1",level:2},{value:"wordclouds.py",id:"wordcloudspy",level:2},{value:"init_wcdb.py",id:"init_wcdbpy",level:2},{value:"main.py",id:"mainpy",level:2}];function _(r){const n={blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",...(0,s.R)(),...r.components};return(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(n.h1,{id:"\u8bcd\u4e91\u7edf\u8ba1",children:"\u8bcd\u4e91\u7edf\u8ba1"}),"\n",(0,e.jsx)(n.p,{children:"2024-6-14"}),"\n",(0,e.jsx)(n.hr,{}),"\n",(0,e.jsx)(n.h2,{id:"\u529f\u80fd\u8bbe\u8ba1",children:"\u529f\u80fd\u8bbe\u8ba1"}),"\n",(0,e.jsx)(n.p,{children:"\u76f4\u63a5\u7b80\u5355\u8bf4\u660e\u4e2a\u4eba\u60f3\u6cd5"}),"\n",(0,e.jsx)(n.p,{children:"\u8be5\u529f\u80fd\u5b58\u653e\u4e8escripts/WordCloud/\u4e0b\uff0c\u5176\u4e2d\u6709\u4ee5\u4e0b\u5185\u5bb9\uff1a"}),"\n",(0,e.jsxs)(n.blockquote,{children:["\n",(0,e.jsx)(n.p,{children:"wordcould.py--\x3e\u7528\u4e8e\u5904\u7406\u8bcd\u4e91"}),"\n",(0,e.jsx)(n.p,{children:"init_wcdb.py--\x3e\u5efa\u7acbsqlite3\u6570\u636e\u5e93\u5b58\u50a8\u5185\u5bb9"}),"\n",(0,e.jsx)(n.p,{children:"groups/--\x3egroups\u6587\u4ef6\u5939\u5b58\u653e\u5185\u5bb9"}),"\n"]}),"\n",(0,e.jsx)(n.p,{children:"\u7136\u540e\u5177\u4f53\u529f\u80fd\u8bbe\u8ba1\u60f3\u6cd5\u662f\u8fd9\u6837\u7684\uff1a"}),"\n",(0,e.jsxs)(n.ol,{children:["\n",(0,e.jsx)(n.li,{children:"\u7ba1\u7406\u5458\u6216\u8005\u8d85\u7ea7\u7ba1\u7406\u5458\uff08admin\u6216root\uff09\u53ef\u4ee5\u6253\u5f00\u4e0e\u5173\u95ed\u8bcd\u4e91\u529f\u80fd\uff0c\u5177\u4f53\u547d\u4ee4\u662f/wc on\u548c/wc off\uff08\u7ba1\u7406\u5458\u76f8\u5173\u4ee3\u7801\u548c\u6570\u636e\u5e93\u5728\u4e0a\u4f20\u7684/app/admin.py\u548c/app/admin.db\uff0cdb\u7684\u7ed3\u6784\u662f    user_id TEXT PRIMARY KEY,    permissions TEXT\uff09"}),"\n",(0,e.jsx)(n.li,{children:"\u751f\u6210\u4e00\u4e2a\u6570\u636e\u5e93\uff0c\u5305\u542b\u5f00\u542f\u8be5\u529f\u80fd\u7684QQ\u7fa4\u3001\u5f00\u542f\u4eba\u8d26\u53f7\u3001\u5f00\u542f\u72b6\u6001 \u5373group_id,user_id,IsOpen\uff0c\u5f53\u7528\u6237B\uff08\u7ba1\u7406\u5458\u7528\u6237\uff09\u5728A\u7fa4\u8f93\u5165/wc on\u7684\u65f6\u5019\uff0c\u6570\u636e\u5e93\u8be5\u6761\u5185\u5bb9\u4e3a A,B,1 \u8f93\u5165/wc off\u7684\u65f6\u5019\uff0c\u4e3a\uff1a A,B,0"}),"\n",(0,e.jsx)(n.li,{children:"\u5f53\u6bcf\u6b21\u8f93\u5165/wc on\u7684\u65f6\u5019\uff0c\u5224\u65ad\u8be5\u7fa4\u804a\u662f\u5426\u5df2\u7ecf\u5f00\u542f\uff0c\u5982\u5df2\u7ecf\u5f00\u542f\u5219\u63d0\u793a\uff1a\u8be5\u7fa4\u5df2\u7ecf\u6253\u5f00\u8bcd\u4e91\u7edf\u8ba1\uff01\uff0c\u5982\u679c\u4e3a\u9996\u6b21\u5f00\u542f\u6216\u8005\u4ece\u5173\u95ed\u5230\u5f00\u542f\uff0c\u5219\u63d0\u793a\uff1a\u8bcd\u4e91\u7edf\u8ba1\u5f00\u542f\u6210\u529f\u3002 \u540c\u65f6\uff0c\u5982\u679c\u4e3a\u9996\u6b21\u5f00\u542f\u6216\u8005\u4ece\u5173\u95ed\u5230\u5f00\u542f\uff0c\u5219\u5728groups\u6587\u4ef6\u5939\u4e0b\u521b\u5efa\u4e00\u4e2atxt\u6587\u4ef6\u6765\u5b58\u653e\u6d88\u606f\u8bb0\u5f55\uff0c\u6587\u4ef6\u540d\u4e3agroup_id.txt\uff0c\u4f8b\u5982QQ\u7fa4\u53f71234567\uff08\u540e\u9762\u90fd\u4ee51234567\u4e3a\u4f8b\uff09\uff0c\u5219\u751f\u6210/scripts/WordCloud/groups/1234567.txt\uff0c\u5982\u679c\u5df2\u7ecf\u5f00\u542f\u5219\u4e0d\u8fdb\u884c\u4efb\u4f55\u64cd\u4f5c\u3002 \u5982\u679c\u7ba1\u7406\u5458\u6216\u8d85\u7ea7\u7ba1\u7406\u5458\u8f93\u5165/wc off\u7684\u65f6\u5019\uff0c\u5219\u5220\u9664/scripts/WordCloud/groups/1234567.txt\u6587\u4ef6"}),"\n",(0,e.jsxs)(n.li,{children:["\u5982\u679c\u8be5\u7fa4\u5f00\u542f\u4e86\u8bcd\u4e91\u529f\u80fd\uff0c\u5219\u5728\u6bcf\u5929\u768423:59\u5206\u7edf\u8ba1\u8be5\u7fa4\u7684\u8bcd\u4e91\u5e76\u751f\u6210\u56fe\u7247\u5b58\u653e\u5728/groups/1234567.png\u4e2d\uff0c\u7136\u540e\u4f7f\u7528go-cqhttp\u7684[CQ",":image",',file=<filename>]\u8fdb\u884c\u56fe\u7247\u7684\u53d1\u9001\uff0c\u4f8b\u5982\u53d1\u9001\u5185\u5bb9"send_group_message(group_id, "\u672c\u7fa4\u4eca\u65e5\u804a\u5929\u8bb0\u5f55\u8bcd\u4e91\u7edf\u8ba1\u5982\u4e0b[CQ',":image",',file=./groups/1234567.png]") \u540c\u65f6\u5728\u53d1\u9001\u540e\u5220\u9664\u8be51234567.png\u548c1234567.txt\uff0c\u7136\u540e\u521b\u5efa\u65b0\u76841234567.txt\u7edf\u8ba1\u65b0\u4e00\u5929\u7684\u5185\u5bb9']}),"\n",(0,e.jsx)(n.li,{children:"\u5982\u679c\u6709\u7528\u6237\uff08\u6240\u6709\u7528\u6237\u5747\u53ef\uff09\u60f3\u63d0\u524d\u67e5\u8be2\u5f53\u65e5\u7684\u8bcd\u4e91\uff0c\u90a3\u4e48\u4ed6\u53ef\u4ee5\u8f93\u5165/wc show\u547d\u4ee4\u63d0\u524d\u751f\u6210\u8bcd\u4e91\uff0c\u5b58\u653e\u4f9d\u65e7\u4e3a/groups/1234567.png\uff0c\u53d1\u9001\u4e4b\u540e\u4e0d\u4f1a\u5220\u96641234567.txt\uff0c\u4f46\u662f\u4f1a\u5220\u96641234567.png\u56fe\u7247"}),"\n"]}),"\n",(0,e.jsx)(n.p,{children:"\u7136\u540e\u9700\u8981\u5b89\u88c5\u6240\u9700\u8981\u7684\u5e93"}),"\n",(0,e.jsx)(n.pre,{children:(0,e.jsx)(n.code,{className:"language-sh",children:"pip install matplotlib wordcloud\n"})}),"\n",(0,e.jsx)(n.h2,{id:"wordcloudspy",children:"wordclouds.py"}),"\n",(0,e.jsx)(n.pre,{children:(0,e.jsx)(n.code,{className:"language-python",children:'import os\r\nimport sqlite3\r\nfrom wordcloud import WordCloud\r\nimport logging\r\n\r\nDATABASE_PATH = os.path.join(os.path.dirname(__file__), \'wordcloud.db\')\r\nGROUPS_DIR = os.path.join(os.path.dirname(__file__), \'groups\')\r\nFONT_PATH = \'/usr/share/fonts/truetype/simhei.ttf\'  # \u4f7f\u7528SimHei\u5b57\u4f53\r\n\r\n\r\ndef toggle_wordcloud(group_id, user_id, is_open, send_group_message):\r\n    conn = sqlite3.connect(DATABASE_PATH)\r\n    cursor = conn.cursor()\r\n\r\n    cursor.execute(\'SELECT is_open FROM wordcloud_groups WHERE group_id = ?\', (group_id,))\r\n    row = cursor.fetchone()\r\n\r\n    if row:\r\n        if row[0] == is_open:\r\n            if is_open:\r\n                send_group_message(group_id, "\u8be5\u7fa4\u5df2\u7ecf\u6253\u5f00\u8bcd\u4e91\u7edf\u8ba1\uff01")\r\n            else:\r\n                send_group_message(group_id, "\u8be5\u7fa4\u5df2\u7ecf\u5173\u95ed\u8bcd\u4e91\u7edf\u8ba1\uff01")\r\n        else:\r\n            cursor.execute(\'UPDATE wordcloud_groups SET is_open = ?, user_id = ? WHERE group_id = ?\',\r\n                           (is_open, user_id, group_id))\r\n            if is_open:\r\n                if not os.path.exists(GROUPS_DIR):\r\n                    os.makedirs(GROUPS_DIR)\r\n                open(os.path.join(GROUPS_DIR, f"{group_id}.txt"), \'w\').close()\r\n                send_group_message(group_id, "\u8bcd\u4e91\u7edf\u8ba1\u5f00\u542f\u6210\u529f\u3002")\r\n            else:\r\n                os.remove(os.path.join(GROUPS_DIR, f"{group_id}.txt"))\r\n                send_group_message(group_id, "\u8bcd\u4e91\u7edf\u8ba1\u5173\u95ed\u6210\u529f\u3002")\r\n    else:\r\n        cursor.execute(\'INSERT INTO wordcloud_groups (group_id, user_id, is_open) VALUES (?, ?, ?)\',\r\n                       (group_id, user_id, is_open))\r\n        if is_open:\r\n            if not os.path.exists(GROUPS_DIR):\r\n                os.makedirs(GROUPS_DIR)\r\n            open(os.path.join(GROUPS_DIR, f"{group_id}.txt"), \'w\').close()\r\n            send_group_message(group_id, "\u8bcd\u4e91\u7edf\u8ba1\u5f00\u542f\u6210\u529f\u3002")\r\n\r\n    conn.commit()\r\n    conn.close()\r\n\r\n\r\ndef generate_wordcloud(group_id, send_group_message):\r\n    txt_path = os.path.join(GROUPS_DIR, f"{group_id}.txt")\r\n    png_path = os.path.join(GROUPS_DIR, f"{group_id}.png")\r\n\r\n    logging.info(f"Generating wordcloud for group {group_id}")\r\n    logging.info(f"Text file path: {txt_path}")\r\n    logging.info(f"PNG file path: {png_path}")\r\n\r\n    if not os.path.exists(txt_path) or os.path.getsize(txt_path) == 0:\r\n        send_group_message(group_id, "\u6ca1\u6709\u8db3\u591f\u7684\u6570\u636e\u751f\u6210\u8bcd\u4e91\u3002")\r\n        return None\r\n\r\n    with open(txt_path, \'r\', encoding=\'utf-8\') as file:\r\n        text = file.read()\r\n\r\n    logging.info(f"Text content: {text}")\r\n\r\n    if not text.strip():\r\n        send_group_message(group_id, "\u6ca1\u6709\u8db3\u591f\u7684\u6570\u636e\u751f\u6210\u8bcd\u4e91\u3002")\r\n        return None\r\n\r\n    try:\r\n        wordcloud = WordCloud(\r\n            width=800,\r\n            height=400,\r\n            background_color=\'white\',\r\n            font_path=FONT_PATH,\r\n            colormap=\'viridis\',\r\n            max_font_size=200,\r\n            random_state=42\r\n        ).generate(text)\r\n        wordcloud.to_file(png_path)\r\n        return png_path\r\n    except Exception as e:\r\n        logging.error(f"Failed to generate wordcloud: {e}")\r\n        send_group_message(group_id, "\u751f\u6210\u8bcd\u4e91\u65f6\u53d1\u751f\u9519\u8bef\u3002")\r\n        return None\r\n\r\n\r\ndef handle_wordcloud_command(command, group_id, user_id, send_group_message, is_admin):\r\n    if command == \'on\' or command == \'off\':\r\n        if not is_admin(user_id):\r\n            send_group_message(group_id, "\u4f60\u6ca1\u6709\u6743\u9650\u6267\u884c\u6b64\u547d\u4ee4\u3002")\r\n            return\r\n\r\n    if command == \'on\':\r\n        toggle_wordcloud(group_id, user_id, 1, send_group_message)\r\n    elif command == \'off\':\r\n        toggle_wordcloud(group_id, user_id, 0, send_group_message)\r\n    elif command == \'show\':\r\n        png_path = generate_wordcloud(group_id, send_group_message)\r\n        if png_path:\r\n            absolute_png_path = f"file:///root/NapCat/app/scripts/WordCloud/groups/{group_id}.png"\r\n            send_group_message(group_id, f"\u672c\u7fa4\u4eca\u65e5\u804a\u5929\u8bb0\u5f55\u8bcd\u4e91\u7edf\u8ba1\u5982\u4e0b[CQ:image,file={absolute_png_path}]")\r\n            os.remove(png_path)\r\n    else:\r\n        send_group_message(group_id, "\u547d\u4ee4\u683c\u5f0f\u9519\u8bef\u3002")\r\n\r\n\r\ndef record_message(group_id, message):\r\n    conn = sqlite3.connect(DATABASE_PATH)\r\n    cursor = conn.cursor()\r\n\r\n    cursor.execute(\'SELECT is_open FROM wordcloud_groups WHERE group_id = ?\', (group_id,))\r\n    row = cursor.fetchone()\r\n\r\n    if row and row[0] == 1:\r\n        txt_path = os.path.join(GROUPS_DIR, f"{group_id}.txt")\r\n        with open(txt_path, \'a\', encoding=\'utf-8\') as file:\r\n            logging.info(f"Recording message to {txt_path}: {message}")\r\n            file.write(message + \'\\n\')\r\n\r\n    conn.close()\n'})}),"\n",(0,e.jsx)(n.h2,{id:"init_wcdbpy",children:"init_wcdb.py"}),"\n",(0,e.jsx)(n.pre,{children:(0,e.jsx)(n.code,{className:"language-python",children:"import sqlite3\r\nimport os\r\n\r\nDATABASE_PATH = os.path.join(os.path.dirname(__file__), 'wordcloud.db')\r\n\r\ndef init_db():\r\n    conn = sqlite3.connect(DATABASE_PATH)\r\n    cursor = conn.cursor()\r\n    cursor.execute('''\r\n    CREATE TABLE IF NOT EXISTS wordcloud_groups (\r\n        group_id TEXT PRIMARY KEY,\r\n        user_id TEXT,\r\n        is_open INTEGER\r\n    )\r\n    ''')\r\n    conn.commit()\r\n    conn.close()\r\n\r\nif __name__ == \"__main__\":\r\n    init_db()\r\n\n"})}),"\n",(0,e.jsx)(n.h2,{id:"mainpy",children:"main.py"}),"\n",(0,e.jsx)(n.p,{children:"\u4fee\u6539\u6dfb\u52a0\u4e00\u4e0b\u4e1a\u52a1\u529f\u80fd\u5c31\u884c"}),"\n",(0,e.jsx)(n.pre,{children:(0,e.jsx)(n.code,{className:"language-python",children:"def receive_event():\r\n    elif message.startswith('/wc'):\r\n    parts = message.split()\r\n    if len(parts) >= 2:\r\n        handle_wordcloud_command(parts[1], group_id, user_id, send_group_message, is_admin)\r\n    else:\r\n        send_group_message(group_id, \"\u547d\u4ee4\u683c\u5f0f\u9519\u8bef\u3002\")\r\n\r\ndef generate_daily_wordcloud():\r\n    conn = sqlite3.connect(os.path.join('scripts', 'WordCloud', 'wordcloud.db'))\r\n    cursor = conn.cursor()\r\n    cursor.execute('SELECT group_id FROM wordcloud_groups WHERE is_open = 1')\r\n    groups = cursor.fetchall()\r\n    conn.close()\r\n\r\n    for group in groups:\r\n        group_id = group[0]\r\n        png_path = generate_wordcloud(group_id, send_group_message)\r\n        if png_path:\r\n            absolute_png_path = f\"file:///root/NapCat/app/scripts/WordCloud/groups/{group_id}.png\"\r\n            send_group_message(group_id, f\"\u672c\u7fa4\u4eca\u65e5\u804a\u5929\u8bb0\u5f55\u8bcd\u4e91\u7edf\u8ba1\u5982\u4e0b[CQ:image,file={absolute_png_path}]\")\r\n            os.remove(png_path)\r\n            txt_path = os.path.join('scripts', 'WordCloud', 'groups', f\"{group_id}.txt\")\r\n            if os.path.exists(txt_path):\r\n                os.remove(txt_path)\r\n            open(txt_path, 'w').close()\r\n\r\ndef schedule_tasks():\r\n    schedule.every().day.at(\"23:59\").do(generate_daily_wordcloud)\r\n\r\n    while True:\r\n        schedule.run_pending()\r\n        time.sleep(1)\n"})}),"\n",(0,e.jsx)(n.p,{children:"\u6700\u540e\u7ed3\u6784"}),"\n",(0,e.jsx)(n.pre,{children:(0,e.jsx)(n.code,{className:"language-txt",children:"\u2514\u2500\u2500 scripts\r\n    \u251c\u2500\u2500 WordCloud\r\n    \u2502\xa0\xa0 \u251c\u2500\u2500 __pycache__\r\n    \u2502\xa0\xa0 \u2502\xa0\xa0 \u2514\u2500\u2500 wordclouds.cpython-310.pyc\r\n    \u2502\xa0\xa0 \u251c\u2500\u2500 groups\r\n    \u2502\xa0\xa0 \u251c\u2500\u2500 init_wcdb.py\r\n    \u2502\xa0\xa0 \u251c\u2500\u2500 wordcloud.db\r\n    \u2502\xa0\xa0 \u2514\u2500\u2500 wordclouds.py\n"})})]})}function c(r={}){const{wrapper:n}={...(0,s.R)(),...r.components};return n?(0,e.jsx)(n,{...r,children:(0,e.jsx)(_,{...r})}):_(r)}},28453:(r,n,o)=>{o.d(n,{R:()=>i,x:()=>d});var e=o(96540);const s={},t=e.createContext(s);function i(r){const n=e.useContext(t);return e.useMemo((function(){return"function"==typeof r?r(n):{...n,...r}}),[n,r])}function d(r){let n;return n=r.disableParentContext?"function"==typeof r.components?r.components(s):r.components||s:i(r.components),e.createElement(t.Provider,{value:n},r.children)}}}]);